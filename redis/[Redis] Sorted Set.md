# Sorted Set

Redis에서 제공해주는 자료구조 중 하나.
일반적인 Set 자료구조는 중복되지 않게 저장되지만 순서가 관리되지 않는다.

## Sorted Set 데이터 구조

Sorted Set은 내부적으로 두 가지 데이터 구조로 저장된다.
몇 가지 기준으로 변환되는데 `redis.conf`의 `ADVANCDE CONFIG`파트에 있고 변경할 수 있다.

```
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
```

### 두 가지 데이터 구조를 사용하는 이유
zip list는 메모리 절약에 최적화된 구조.
레디스는 메모리 데이터베이스에고 데이터 타입에 따라서 메모리 오버헤드가 많을 수 있다.
성능을 많이 해치지 않는 범위에서 메모리 절약을 할 수 있는 데이터 구조를 사용하게 됐다.
Zset을 위한 메인 데이터 구조는 skip list

### 짚 리스트 (ZIP LIST)

 - 멤버 수: ~ 128
 - 값 크기: ~ 64 byte

### 스킵 리스트 (SKIP LIST)

 - 멤버 수: 129 ~
 - 값 크기: 65 byte ~
	 - 여러 멤버 중 하나라도 65 이상이면 변환된다.

정렬된 상태를 유지하면서 데이터를 삽입, 삭제하고 탐색할 수 있는 데이터 구조체.

(정렬된 상태를 유지하는)Linked List의 단점을 개선하는 데에서 시작한다.

![linked list의 탐색](http://redisgate.kr/images/internal/skiplist-1a.png)

linked list는 최악의 경우 모든 노드를 비교해야한다.


### Level을 갖는 SKIP LIST

탐색시간을 단축하는 방법은 비교 횟수를 줄이는 것이다.

각 노드에 포인터를 두 개 갖게 해서 두 번째 포인터는 하나 건너 뛰어서 다음 노드를 가리키도록 한다.

![skip list의 탐색](http://redisgate.kr/images/internal/skiplist-1b.png)

홀수번째 노드는 포인터를 하나만 가진다.
짝수번째 노드는 포인터를 두개 가지고 하나는 건너뛴 노드를 가리키도록 한다.

짝수번째 노드의 건너뛴 노드를 가리키는 포인터로 값을 찾으면 비교 횟수를 반으로 줄여버린다.

### 3 Level을 갖는 SKIP LIST

![레벨 3개를 가진 skip list의 탐색](http://redisgate.kr/images/internal/skiplist-1c.png)

맨 앞의 헤더부터 레벨3에서 시작

- 다음값은 20이고 목표값 80보다 작으니 다음 노드 탐색
- 다음값은 70이고 목표값 80보다 작으니 다음 노드 탐색
- 레벨3의 다음 노드는 null이기 때문에 레벨2에서 탐색. 레벨2에서 다음값은 90이고 목표값 80보다 크니 레벨1에서 비교한다.
- 레벨을 1로 낮춰서 90보다 작은 값 탐색
- 80을 찾음
- 총 비교횟수는 4회


### 위의 예시들의 문제점

위의 예시들은 노드 순서마다 **레벨이 미리 정해져있다.**
삽입 삭제 시 모든 노드의 순서가 바뀌고 포인터 정보를 모두 수정해줘야한다.
즉, 삽입/삭제에서 부하가 많이 발생할 수 밖에 없다.

### 레벨을 정하는 방법: 동전 던지기

새로운 노드가 생길 때 마다 같은 면이 연속해서 나온 횟수로 레벨을 정한다.

- 첫번째 던지면 일단 레벨 1
- 두번째 던져서 다른 면이 나오면 레벨1, 같은 면이 나오면 레벨 2로 올리고 다시 던짐
- 세번째 던져서 다른 면이 나오면 레벨2, 같은 면이 나오면 레벨 3으로 올리고 다시 던짐
- ...반복

레벨이 높게 나오면 오히려 관리용 메모리를 필요 이상으로 사용하게 되는 것이기 때문에 높은 레벨이 너무 많이 나오지 않도록 고려해야한다.

### 순서 SPAN

몇 번째 노드인지 알기 어려워졌다.
레디스는 **레벨에 포인터와 순서를 가지는 필드를 만들어 저장**하고, 이 것을 **SPAN**으로 했다.
이것을 **인덱스 스킵 리스트**라고 한다.

### 주사위 던지기

메모리 오버헤드를 줄이는 방법 = 레벨을 낮추는 것
주사위는 같은 결과가 나오면 레벨이 올라감. 확률이 1/2.
주사위를 사용하면 같은 결과가 나올 확률이 1/6.


### 확률

1/4 추천
`server.h`에 다음과 같이 정의했다.

```
#define ZSKIPLIST_P   0.25       /* Skiplist P = 1/4 */
```

## 레디스 스킵 리스트

스킵 리스트에서 몇 가지 수정해서 구현했다.

- 최대 레벨은 32
- 역 탐색을 위해 이전 노드를 가리키는 포인터(back pointer)를 둔다.
- 같은 스코어가 반복되는 것을 허용 (LEX명령을 사용하려면 스코너는 모두 같아야한다.)
- 스코어가 같으면 값을 비교함

### Sorted Set 최대 멤버 수

```text
레디스 스킵 리스트는 멤버를 몇 개까지 가질 수 있을까?
레디스 데이터 타입 문서 에 보면 리스트(Lists), 셋(Set), 해시(Hashes) 모두 2^32 - 1 (4,294,967,295) 약 43억 개를 저장할 수 있다고 나와있다.   그런데 Sorted Set 만 정확한 숫자가 나와있지 않다.   왜 일까?   지금까지 레디스 스킵 리스트를 살펴보았으니 알 것이다.   최대 레벨은 32로 정해져 있지만 스코어 비교 시 레벨을 그대로 두고 다음 포인터로 계속 진행할 수 있으므로 최대 레벨과 관계없이 계속 저장할 수 있다.
제한이 있다면 길이(length) 저장에 unsigned long를 사용했으므로 2^64 = 18,446,744,073,709,600,000 약 일천팔백 경(조 다음 단위가 경이다) 만큼 저장할 수 있다.   사실상 메모리 제한만 있는 것이다.
```
(내용 발쵀)




## 참고

- http://redisgate.kr/redis/configuration/internal_skiplist.php